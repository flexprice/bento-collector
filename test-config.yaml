input:
  file:
    paths:
      - test-input-*.json
    scanner:
      lines: {}

pipeline:
  processors:
    - mapping: |
        let valid = (
          this.orgId != null && this.orgId != "" &&
          this.methodName != null && this.methodName != "" &&
          ((this.providerName != null && this.providerName != "") || (this.serviceName != null && this.serviceName != "")) &&
          this.id != null && this.id != "" &&
          this.createdAt != null && this.createdAt != ""
        )

        root = if $valid { this } else { deleted() }

    - mapping: |
        root = {}

        # Start with `data` fields (extract values from key-value objects, otherwise stringify)
        root.properties = if this.data != null && this.data.type() == "object" {
          this.data.map_each(v -> if v.type() == "object" && v.key != null && v.value != null {
            v.value.string()
          } else {
            v.string()
          })
        } else {
          {}
        }

        root.properties.resolvedProviderName = ""
        if this.providerName != null && this.providerName != "" {
          root.properties.resolvedProviderName = this.providerName.string().trim().lowercase()
        } else if this.serviceName != null && this.serviceName != "" {
          root.properties.resolvedProviderName = this.serviceName.string().trim().lowercase() 
        }

        root.properties.resolvedModelName = ""
        if root.properties.modelName != null && root.properties.modelName != "" {
          root.properties.resolvedModelName = "-" + root.properties.modelName.string().trim().lowercase()
        } else if this.data != null && this.data.modelName != null && this.data.modelName != "" {
          root.properties.resolvedModelName = "-" + this.data.modelName.string().trim().lowercase()
        }

        root.properties.resolvedMethodName = ""
        if this.methodName != null && this.methodName != "" {
          if this.methodName == "BEDROCK_LLM" {
            root.properties.resolvedMethodName = "-modeling"
          } else {
            root.properties.resolvedMethodName = "-" + this.methodName.string().trim().lowercase()
          }
        }

        root.external_customer_id = this.orgId.string()
        root.event_name = root.properties.resolvedProviderName + root.properties.resolvedMethodName + root.properties.resolvedModelName
        root.event_id = this.id.string()
        root.timestamp = this.createdAt.string()
        if this.targetItemId != null { root.source = this.targetItemId.string() }

      
        # Add selected top-level fields into properties
        if this.byok != null {
          root.properties.byok = this.byok.string()
        }
        if this.dataInterface != null { root.properties.dataInterface = this.dataInterface.string() }
        if this.serviceName != null { root.properties.serviceName = this.serviceName.string() }
        if this.providerName != null { root.properties.providerName = this.providerName.string() }
        if this.referenceCost != null { root.properties.referenceCost = this.referenceCost.string() }
        if this.methodName != null { root.properties.methodName = this.methodName.string() }
        if this.targetItemType != null { root.properties.targetItemType = this.targetItemType.string() }
        if this.targetItemId != null { root.properties.targetItemId = this.targetItemId.string() }
        if this.referenceType != null { root.properties.referenceType = this.referenceType.string() }
        if this.referenceId != null { root.properties.referenceId = this.referenceId.string() }
        if this.startedAt != null { root.properties.startedAt = this.startedAt.string() }
        if this.createdAt != null { root.properties.createdAt = this.createdAt.string() }
        if this.updatedAt != null { root.properties.updatedAt = this.updatedAt.string() }
        if this.endedAt != null { root.properties.endedAt = this.endedAt.string() }

        # Initialize billable fields with empty strings
        root.properties.billable_value = ""
        root.properties.billable_unit = ""

        # Add billable_value and billable_unit based on numCharacters or durationMS
        if root.properties.numCharacters != null {
          root.properties.billable_value = root.properties.numCharacters
          root.properties.billable_unit = "characters"
        } else if root.properties.durationMS != null {
          root.properties.billable_value = root.properties.durationMS
          root.properties.billable_unit = "milliseconds"
        }

        # Multiply billable_value by channels if both exist and are valid numbers > 0
        if root.properties.billable_value != "" && root.properties.channels != null && root.properties.billable_value.number().catch(0) > 0 && root.properties.channels.number().catch(0) > 0 {
          root.properties.billable_value = (root.properties.billable_value.number() * root.properties.channels.number()).string()
        }

output:
  stdout:
    codec: lines



#command to run:benthos -c test-config.yaml 2>/dev/null | jq '.properties'